<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>4D Results Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>
<body class="bg-white flex flex-col items-center py-6 px-2 min-h-screen">
  <!-- Date Picker -->
  <div class="w-full flex items-center gap-2 mb-6 px-2 max-w-[1200px]">
    <span class="text-xl font-semibold text-gray-900" style="font-family: Arial, sans-serif;">
      Past Draw Results
    </span>
    <label for="draw-date" class="font-semibold text-gray-800 text-base ml-4" style="font-family: Arial, sans-serif;">
      Date:
    </label>
    <select id="draw-date" class="border border-gray-400 rounded px-3 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500" style="max-width:180px;">
      <!-- dates will be loaded here -->
    </select>
  </div>
  <!-- Results Container -->
  <div id="results-container" class="flex flex-wrap gap-6 max-w-[1200px] w-full justify-center">
    <!-- Results will appear here -->
  </div>
  <script>
    // Map image URLs to provider names and colors (add more if needed)
    const providerMap = {
      "magnum": { name: "Magnum 4D", color: "yellow-300" },
      "damacai": { name: "Da Ma Cai", color: "blue-900" },
      "toto": { name: "Sports Toto", color: "red-900" },
      "granddragon": { name: "Grand Dragon", color: "red-700" },
      "singapore": { name: "Singapore 4D", color: "blue-700" }
      // You can expand with more if needed
    };

    // Util to extract provider shortname from image URL
    function getProviderInfo(url) {
      if (!url) return {key:'unknown', name:'Unknown', color:'gray-300', logo:''};
      let key = '';
      if (url.includes('magnum')) key = 'magnum';
      else if (url.includes('damacai')) key = 'damacai';
      else if (url.includes('toto')) key = 'toto';
      else if (url.includes('dragon')) key = 'granddragon';
      else if (url.includes('singapore')) key = 'singapore';
      else key = 'unknown';

      let def = providerMap[key] || { name: 'Unknown', color: 'gray-300' };
      return {
        key,
        name: def.name,
        color: def.color,
        logo: url
      };
    }

    // Parse "1st Prize 首獎 4529 | 2nd Prize 二獎 7748 | 3rd Prize ..." to numbers
    function extractPrizes(info) {
      if (!info) return {first:'-', second:'-', third:'-'};
      let first = info.match(/1st(?: Prize)?[^\d]*(\d+)/i);
      let second = info.match(/2nd(?: Prize)?[^\d]*(\d+)/i);
      let third = info.match(/3rd(?: Prize)?[^\d]*(\d+)/i);
      return {
        first: first ? first[1] : '-',
        second: second ? second[1] : '-',
        third: third ? third[1] : '-'
      };
    }

    // Parse block for special/consolation (space separated)
    function extractList(field) {
      if (!field) return [];
      // Remove any non-numeric, non-space chars (leave ---- etc)
      return field.split(/\s+/).filter(x => x && (x.match(/^\d+$/) || x === "----" || x === "****"));
    }

    // Parse jackpots if present
    function extractJackpot(field) {
      if (!field) return ['-', '-'];
      let j = field.match(/Jackpot\s*1(?: Prize)?[^\dRM]*([RM\d,\.]+)/i);
      let k = field.match(/Jackpot\s*2(?: Prize)?[^\dRM]*([RM\d,\.]+)/i);
      return [
        j ? j[1] : '-',
        k ? k[1] : '-'
      ];
    }

    // Load CSV and build UI
    Papa.parse('4d_results_history.csv', {
      header: true,
      skipEmptyLines: true,
      download: true,
      complete: function(results) {
        // Flatten index if necessary
        let raw = results.data;

        // Some files have index as part of columns, fix that:
        // If 'date' looks like '2015-01-03 https://....', split
        let clean = raw.map(row => {
          let date = row.date;
          let provider = row.provider;
          if (date && date.match(/^\d{4}-\d{2}-\d{2} /)) {
            let [d, ...rest] = date.split(' ');
            date = d;
            provider = rest.join(' ');
          }
          if (provider && provider.match(/^https?:/)) {
            // OK, is a logo url
          } else if (row.provider && row.provider.match(/^https?:/)) {
            provider = row.provider;
          }
          return {
            date: date,
            provider: provider,
            draw_info: row.draw_info || '',
            one: row['1st'],
            two: row['2nd'],
            three: row['3rd'],
            special: row.special,
            consolation: row.consolation
          };
        });

        // Get all unique dates, latest first
        let dates = [...new Set(clean.map(row => row.date))].sort((a, b) => b.localeCompare(a));
        // Fill the dropdown
        let select = document.getElementById('draw-date');
        dates.forEach(date => {
          let opt = document.createElement('option');
          opt.value = date;
          opt.textContent = date;
          select.appendChild(opt);
        });

        // Render for default (latest) date
        showResults(dates[0], clean);

        select.addEventListener('change', function() {
          showResults(this.value, clean);
        });
      }
    });

    function showResults(date, data) {
      let container = document.getElementById('results-container');
      container.innerHTML = '';
      let todayRows = data.filter(row => row.date === date);
      if (!todayRows.length) {
        container.innerHTML = '<div class="text-center w-full text-lg text-red-600">No results for selected date</div>';
        return;
      }
      todayRows.forEach(row => {
        let prov = getProviderInfo(row.provider);
        let prizes = extractPrizes(row.one);
        let specials = extractList(row.two);
        let consolations = extractList(row.three);

        // Try to extract jackpot info from special/consolation fields
        let [jackpot1, jackpot2] = extractJackpot((row.special || '') + ' ' + (row.consolation || ''));

        container.innerHTML += `
<section class="border border-gray-300 rounded-md shadow-sm max-w-[320px] w-full flex flex-col">
  <header class="flex items-center gap-2 bg-${prov.color} rounded-t-md px-2 py-1">
    ${prov.logo ? `<img src="${prov.logo}" class="w-10 h-10 object-contain" />` : ''}
    <h1 class="font-semibold text-gray-800 text-lg" style="font-family: Arial, sans-serif">
      ${prov.name}
    </h1>
  </header>
  <div class="flex justify-between text-sm px-3 py-1 font-sans text-gray-900" style="font-family: Arial, sans-serif">
    <p>Date: ${row.date}</p>
    <p>${row.draw_info}</p>
  </div>
  <table class="border border-gray-300 border-t-0 border-collapse w-full text-gray-900" style="font-family: Arial, sans-serif">
    <tbody>
      <tr>
        <td class="bg-gray-900 text-white font-semibold-700 text-sm px-3 py-2 text-right">1st Prize</td>
        <td class="border border-gray-300 text-2xl font-extrabold text-center px-3 py-2">${prizes.first}</td>
      </tr>
      <tr>
        <td class="bg-gray-900 text-white font-semibold-700 text-sm px-3 py-2 text-right">2nd Prize</td>
        <td class="border border-gray-300 text-2xl font-extrabold text-center px-3 py-2">${prizes.second}</td>
      </tr>
      <tr>
        <td class="bg-gray-900 text-white font-semibold-700 text-sm px-3 py-2 text-right">3rd Prize</td>
        <td class="border border-gray-300 text-2xl font-extrabold text-center px-3 py-2">${prizes.third}</td>
      </tr>
    </tbody>
  </table>
  <table class="border border-gray-300 border-t-0 border-collapse w-full text-gray-900" style="font-family: Arial, sans-serif">
    <thead>
      <tr><th class="bg-gray-900 text-white font-semibold text-center text-sm py-1" colspan="5">Special</th></tr>
    </thead>
    <tbody>
      <tr>
        ${specials.map(num => `<td class="border border-gray-300 text-center py-1 px-2">${num}</td>`).join('')}
      </tr>
    </tbody>
  </table>
  <table class="border border-gray-300 border-t-0 border-collapse w-full text-gray-900" style="font-family: Arial, sans-serif">
    <thead>
      <tr><th class="bg-gray-900 text-white font-semibold text-center text-sm py-1" colspan="5">Consolation</th></tr>
    </thead>
    <tbody>
      <tr>
        ${consolations.map(num => `<td class="border border-gray-300 text-center py-1 px-2">${num}</td>`).join('')}
      </tr>
    </tbody>
  </table>
  <table class="w-full border-collapse text-gray-900" style="font-family: Arial, sans-serif">
    <thead>
      <tr>
        <th class="bg-gray-900 text-white text-sm font-semibold py-1 px-2 border border-gray-300 text-center">4D Jackpot 1 Prize</th>
        <th class="bg-gray-900 text-white text-sm font-semibold py-1 px-2 border border-gray-300 text-center">4D Jackpot 2 Prize</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td class="bg-gray-300 font-bold text-center py-2 border border-gray-300 text-base">${jackpot1}</td>
        <td class="bg-gray-300 font-bold text-center py-2 border border-gray-300 text-base">${jackpot2}</td>
      </tr>
    </tbody>
  </table>
</section>
        `;
      });
    }
  </script>
</body>
</html>
